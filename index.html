<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at 50% 50%, #1a1a2e, #0f0f1a);
            padding: 15px;
        }

        .game-container {
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border-radius: 50px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8), inset 0 0 20px rgba(255,215,0,0.3);
            max-width: 750px;
            width: 100%;
            border: 3px solid gold;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.5);
            padding: 15px 25px;
            border-radius: 50px;
            border: 2px solid gold;
        }

        .level-box {
            background: gold;
            color: #1a1a3a;
            padding: 10px 30px;
            border-radius: 40px;
            font-size: 28px;
            font-weight: bold;
        }

        .score-box {
            background: #4a2a6a;
            color: gold;
            padding: 10px 30px;
            border-radius: 40px;
            font-size: 28px;
            font-weight: bold;
            border: 2px solid gold;
        }

        /* Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª */
        .boosters-panel {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 25px;
        }

        .booster {
            width: 90px;
            height: 90px;
            background: radial-gradient(circle at 30% 30%, #ffd966, #b8860b);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid gold;
            box-shadow: 0 8px 0 #8b6508;
            cursor: pointer;
            transition: 0.05s;
        }

        .booster:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #8b6508;
        }

        .booster.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .booster-icon {
            font-size: 36px;
        }

        .booster-count {
            background: #1a1a3a;
            color: gold;
            padding: 2px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        .board-wrapper {
            background: #2a1a4a;
            padding: 25px;
            border-radius: 60px;
            border: 4px solid gold;
            margin-bottom: 25px;
        }

        .board {
            display: inline-grid;
            gap: 8px;
            justify-content: center;
            width: 100%;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù†ÙŠØ© */
        .cell {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ffd700, #b8860b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #1a1a2e;
            text-shadow: 0 2px 5px rgba(255,255,255,0.5);
            box-shadow: 0 8px 0 #8b6508, 0 10px 20px rgba(0,0,0,0.5);
            cursor: grab;
            transition: 0.05s;
            border: 3px solid #ffd700;
            position: relative;
        }

        .cell:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .cell.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 6px gold, 0 8px 0 #8b6508, 0 15px 25px black;
            z-index: 10;
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
        .num-1 { background: radial-gradient(circle at 35% 35%, #ffb3b3, #ff4d4d); }
        .num-2 { background: radial-gradient(circle at 35% 35%, #b3ffb3, #4dff4d); }
        .num-3 { background: radial-gradient(circle at 35% 35%, #b3b3ff, #4d4dff); }
        .num-4 { background: radial-gradient(circle at 35% 35%, #ffb3ff, #ff4dff); }
        .num-5 { background: radial-gradient(circle at 35% 35%, #ffffb3, #ffff4d); }
        .num-6 { background: radial-gradient(circle at 35% 35%, #ffd9b3, #ffaa4d); }

        /* Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª */
        .cell.obstacle {
            background: radial-gradient(circle at 35% 35%, #95a5a6, #4a4a4a);
            box-shadow: 0 5px 0 #2c3e50;
            border-color: #7f8c8d;
            cursor: not-allowed;
        }

        .cell.obstacle::after {
            content: "â›”";
            position: absolute;
            font-size: 30px;
            color: white;
            text-shadow: 0 2px 5px black;
        }

        .cell.ice {
            position: relative;
        }

        .cell.ice::after {
            content: "â„ï¸";
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            filter: drop-shadow(0 0 5px cyan);
        }

        @keyframes matchPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); filter: brightness(1.5); }
            100% { transform: scale(0); }
        }

        .cell.matching {
            animation: matchPop 0.2s ease forwards;
            pointer-events: none;
        }

        @keyframes shake {
            0%,100% { transform: translateX(0); }
            25% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }

        .cell.error {
            animation: shake 0.2s;
        }

        /* Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© */
        .hint-btn {
            background: linear-gradient(145deg, gold, orange);
            color: #1a1a2e;
            font-size: 24px;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 0 auto 20px;
            width: fit-content;
            box-shadow: 0 8px 0 #b8860b;
            transition: 0.05s;
        }

        .hint-btn:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #b8860b;
        }

        .cell.hint {
            animation: hintPulse 0.8s infinite;
            box-shadow: 0 0 0 6px cyan, 0 8px 0 #8b6508, 0 15px 25px black;
        }

        @keyframes hintPulse {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            background: linear-gradient(145deg, #4a2a6a, #2a1a4a);
            border: 3px solid gold;
            color: gold;
            font-size: 24px;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.05s;
            box-shadow: 0 6px 0 #1a0f2a;
            flex: 1;
            max-width: 180px;
            text-align: center;
        }

        .nav-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1a0f2a;
        }

        .nav-btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, gold, orange);
            color: #1a1a2e;
            padding: 30px 50px;
            border-radius: 60px;
            font-size: 36px;
            font-weight: bold;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
            display: none;
            z-index: 1000;
            border: 5px solid white;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="header">
            <div class="level-box" id="levelDisplay">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</div>
            <div class="score-box" id="scoreDisplay">0</div>
        </div>

        <!-- Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª -->
        <div class="boosters-panel">
            <div class="booster" onclick="useBooster('arrow')" id="boosterArrow">
                <div class="booster-icon">â¬…ï¸â¡ï¸</div>
                <div class="booster-count" id="arrowCount">0</div>
            </div>
            <div class="booster" onclick="useBooster('bomb')" id="boosterBomb">
                <div class="booster-icon">ğŸ’£</div>
                <div class="booster-count" id="bombCount">0</div>
            </div>
        </div>

        <!-- Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© -->
        <button class="hint-btn" onclick="useHint()">
            <span>ğŸ’¡</span> Ù…Ø³Ø§Ø¹Ø¯Ø© (30 Ù†Ù‚Ø·Ø©)
        </button>

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨ -->
        <div class="board-wrapper">
            <div class="board" id="board"></div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <div class="nav-buttons">
            <div class="nav-btn" onclick="prevLevel()" id="prevBtn">â—€ Ø±Ø¬ÙˆØ¹</div>
            <div class="nav-btn" onclick="resetLevel()">Ø¥Ø¹Ø§Ø¯Ø©</div>
            <div class="nav-btn" onclick="nextLevel()" id="nextBtn">ØªØ§Ù„ÙŠ â–¶</div>
        </div>
    </div>

    <div class="message-popup" id="messagePopup"></div>

    <script>
        // ------------------------------------------------------------
        //                     Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        // ------------------------------------------------------------

        // Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©
        let completedLevels = JSON.parse(localStorage.getItem('completedLevels')) || [];

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let currentLevel = 0;
        let board = [];
        let score = 0;
        let selectedRow = -1, selectedCol = -1;
        let boosters = { arrow: 0, bomb: 0 };
        let gameActive = true;
        let numbersPool = [];

        // ------------------------------------------------------------
        //                     ØªÙˆÙ„ÙŠØ¯ 20 Ù…Ø±Ø­Ù„Ø©
        // ------------------------------------------------------------
        function generateLevels() {
            let levels = [];
            for (let i = 1; i <= 20; i++) {
                let uniqueNumbers, obstacleCount, iceCount, target;
                
                if (i <= 3) {
                    uniqueNumbers = 3;
                    obstacleCount = 0;
                    iceCount = 0;
                    target = 200;
                } else if (i <= 5) {
                    uniqueNumbers = 4;
                    obstacleCount = 3;
                    iceCount = 1;
                    target = 350;
                } else if (i <= 10) {
                    uniqueNumbers = 5;
                    obstacleCount = 5;
                    iceCount = 2;
                    target = 500;
                } else {
                    uniqueNumbers = 6;
                    obstacleCount = 7;
                    iceCount = 3;
                    target = 700;
                }

                levels.push({
                    id: i,
                    rows: i > 15 ? 7 : 6,
                    cols: i > 15 ? 7 : 6,
                    target: target + i * 20,
                    uniqueNumbers: uniqueNumbers,
                    obstacles: generateObstacles(obstacleCount, i > 15 ? 7 : 6, i > 15 ? 7 : 6),
                    ice: generateIce(iceCount, i > 15 ? 7 : 6, i > 15 ? 7 : 6),
                    arrowRate: i <= 3 ? 0.9 : i <= 5 ? 0.5 : 0.2,
                    bombRate: i <= 3 ? 0.7 : i <= 5 ? 0.3 : 0.1
                });
            }
            return levels;
        }

        function generateObstacles(count, rows, cols) {
            let obs = [];
            for (let i = 0; i < count; i++) {
                obs.push({ row: Math.floor(Math.random() * rows), col: Math.floor(Math.random() * cols) });
            }
            return obs;
        }

        function generateIce(count, rows, cols) {
            let ice = [];
            for (let i = 0; i < count; i++) {
                ice.push({ row: Math.floor(Math.random() * rows), col: Math.floor(Math.random() * cols), layers: 2 });
            }
            return ice;
        }

        const levels = generateLevels();

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        function updateNumbersPool(level) {
            numbersPool = [];
            for (let i = 1; i <= level.uniqueNumbers; i++) numbersPool.push(i);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø¨Ø¯ÙˆÙ† ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø£ÙˆÙ„ÙŠØ©
        function createRandomBoard(rows, cols) {
            let b = [];
            for (let r = 0; r < rows; r++) {
                let row = [];
                for (let c = 0; c < cols; c++) {
                    row.push(numbersPool[Math.floor(Math.random() * numbersPool.length)]);
                }
                b.push(row);
            }
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø£ÙˆÙ„ÙŠØ©
            while (hasInitialMatches(b)) {
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        b[r][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                    }
                }
            }
            return b;
        }

        function hasInitialMatches(board) {
            let rows = board.length, cols = board[0].length;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols - 2; c++) {
                    if (board[r][c] === board[r][c+1] && board[r][c] === board[r][c+2]) return true;
                }
            }
            for (let c = 0; c < cols; c++) {
                for (let r = 0; r < rows - 2; r++) {
                    if (board[r][c] === board[r+1][c] && board[r][c] === board[r+2][c]) return true;
                }
            }
            return false;
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª (Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        // ------------------------------------------------------------
        function checkMatches(board) {
            let matches = [];
            let matchDetails = [];
            let rows = board.length, cols = board[0].length;

            // Ø£ÙÙ‚ÙŠ
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols - 2; c++) {
                    if (board[r][c] && board[r][c+1] && board[r][c+2] && 
                        board[r][c] === board[r][c+1] && board[r][c] === board[r][c+2]) {
                        
                        let len = 3;
                        let val = board[r][c];
                        
                        if (c+3 < cols && board[r][c] === board[r][c+3]) {
                            len = 4;
                            if (c+4 < cols && board[r][c] === board[r][c+4]) len = 5;
                        }
                        
                        for (let i = 0; i < len; i++) {
                            matches.push([r, c+i]);
                            matchDetails.push({ row: r, col: c+i, value: val, length: len });
                        }
                    }
                }
            }

            // Ø¹Ù…ÙˆØ¯ÙŠ
            for (let c = 0; c < cols; c++) {
                for (let r = 0; r < rows - 2; r++) {
                    if (board[r][c] && board[r+1][c] && board[r+2][c] && 
                        board[r][c] === board[r+1][c] && board[r][c] === board[r+2][c]) {
                        
                        let len = 3;
                        let val = board[r][c];
                        
                        if (r+3 < rows && board[r][c] === board[r+3][c]) {
                            len = 4;
                            if (r+4 < rows && board[r][c] === board[r+4][c]) len = 5;
                        }
                        
                        for (let i = 0; i < len; i++) {
                            matches.push([r+i, c]);
                            matchDetails.push({ row: r+i, col: c, value: val, length: len });
                        }
                    }
                }
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
            matches = [...new Set(matches.map(JSON.stringify))].map(JSON.parse);
            
            // ØªØ¬Ù…ÙŠØ¹ ÙØ±ÙŠØ¯ Ù„Ù„ØªÙØ§ØµÙŠÙ„
            let uniqueDetails = [];
            let seen = new Set();
            matchDetails.forEach(d => {
                let key = `${d.row},${d.col}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueDetails.push(d);
                }
            });

            return { matches, matchDetails: uniqueDetails };
        }

        // ------------------------------------------------------------
        //                     Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·
        // ------------------------------------------------------------
        function removeMatches(board, matches, matchDetails) {
            let level = levels[currentLevel];
            let rows = board.length, cols = board[0].length;
            let removed = Array(rows).fill().map(() => Array(cols).fill(false));
            let totalPoints = 0;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
            matches.forEach(([r, c]) => {
                removed[r][c] = true;
                let detail = matchDetails.find(d => d.row === r && d.col === c);
                if (detail) {
                    // Ø§Ù„Ù†Ù‚Ø§Ø· = Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù‚Ù… Ã— Ø·ÙˆÙ„ Ø§Ù„ØªØ·Ø§Ø¨Ù‚
                    let points = detail.value * detail.length;
                    totalPoints += points;
                    
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø²Ø²Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø·ÙˆÙ„
                    if (detail.length === 4 && Math.random() < level.arrowRate) {
                        boosters.arrow++;
                        showMessage(`ğŸ¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø³Ù‡Ù…!`, 1000);
                    } else if (detail.length === 5 && Math.random() < level.bombRate) {
                        boosters.bomb++;
                        showMessage(`ğŸ’£ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù‚Ù†Ø¨Ù„Ø©!`, 1000);
                    }
                }
            });

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ù†ØªÙŠØ¬Ø©
            score += totalPoints;
            showMessage(`+${totalPoints} Ù†Ù‚Ø·Ø©`, 800);

            // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
            document.querySelectorAll('.cell').forEach((cell, index) => {
                let r = Math.floor(index / cols);
                let c = index % cols;
                if (removed[r] && removed[r][c]) {
                    cell.classList.add('matching');
                }
            });

            // Ø¥Ø³Ù‚Ø§Ø· Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            setTimeout(() => {
                for (let c = 0; c < cols; c++) {
                    for (let r = rows-1; r >= 0; r--) {
                        if (removed[r][c]) {
                            for (let k = r-1; k >= 0; k--) {
                                if (!removed[k][c]) {
                                    board[r][c] = board[k][c];
                                    removed[k][c] = true;
                                    removed[r][c] = false;
                                    break;
                                }
                            }
                            if (removed[r][c]) {
                                board[r][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                            }
                        }
                    }
                }
                renderBoard();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„Ø©
                setTimeout(() => {
                    let { matches: moreMatches, matchDetails: moreDetails } = checkMatches(board);
                    if (moreMatches.length > 0) {
                        removeMatches(board, moreMatches, moreDetails);
                    }
                }, 300);
            }, 200);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ²
            if (score >= level.target && !completedLevels.includes(currentLevel)) {
                completedLevels.push(currentLevel);
                localStorage.setItem('completedLevels', JSON.stringify(completedLevels));
                showMessage(`ğŸ‰ ÙØ²Øª Ø¨Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${level.id}!`, 3000);
            }
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ø¨Ø·Ø±ÙŠÙ‚ØªÙŠÙ†
        // ------------------------------------------------------------
        function handleCellInteraction(r, c, isDrag = false) {
            if (!gameActive) return;
            
            let level = levels[currentLevel];
            if (level.obstacles.some(o => o.row === r && o.col === c)) return;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ù…Ø¹Ø²Ø² Ù…Ø®ØªØ§Ø±
            if (selectedBooster) {
                if (selectedBooster === 'arrow' && boosters.arrow > 0) {
                    useArrow(r, c);
                    selectedBooster = null;
                } else if (selectedBooster === 'bomb' && boosters.bomb > 0) {
                    useBomb(r, c);
                    selectedBooster = null;
                }
                return;
            }

            // Ø£ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±
            if (selectedRow === -1) {
                selectedRow = r;
                selectedCol = c;
                renderBoard();
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¬Ø§ÙˆØ±
            let rowDiff = Math.abs(r - selectedRow);
            let colDiff = Math.abs(c - selectedCol);
            let isAdjacent = (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);

            if (isAdjacent) {
                // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø®Ù„ÙŠØªÙŠÙ†
                let temp = board[r][c];
                board[r][c] = board[selectedRow][selectedCol];
                board[selectedRow][selectedCol] = temp;

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª
                let { matches, matchDetails } = checkMatches(board);
                
                if (matches.length > 0) {
                    removeMatches(board, matches, matchDetails);
                } else {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚
                    temp = board[r][c];
                    board[r][c] = board[selectedRow][selectedCol];
                    board[selectedRow][selectedCol] = temp;
                    
                    // ØªØ£Ø«ÙŠØ± Ø®Ø·Ø£
                    document.querySelectorAll('.cell').forEach(c => c.classList.add('error'));
                    setTimeout(() => document.querySelectorAll('.cell').forEach(c => c.classList.remove('error')), 200);
                }
            }

            selectedRow = -1;
            selectedCol = -1;
            renderBoard();
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª
        // ------------------------------------------------------------
        let selectedBooster = null;

        function useBooster(type) {
            if (boosters[type] <= 0) return;
            selectedBooster = type;
            showMessage(`Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ${type === 'arrow' ? 'Ø§Ù„Ø³Ù‡Ù…' : 'Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©'}`, 1500);
        }

        function useArrow(row, col) {
            let level = levels[currentLevel];
            let rows = board.length, cols = board[0].length;
            let direction = confirm('Ø§Ø¶ØºØ· OK Ù„Ù„ØµÙ, Cancel Ù„Ù„Ø¹Ù…ÙˆØ¯') ? 'row' : 'col';
            let points = 0;

            if (direction === 'row') {
                for (let c = 0; c < cols; c++) {
                    if (!level.obstacles.some(o => o.row === row && o.col === c)) {
                        points += board[row][c];
                        board[row][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                    }
                }
            } else {
                for (let r = 0; r < rows; r++) {
                    if (!level.obstacles.some(o => o.row === r && o.col === col)) {
                        points += board[r][col];
                        board[r][col] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                    }
                }
            }

            score += points;
            boosters.arrow--;
            showMessage(`â• ${points} Ù†Ù‚Ø·Ø© Ù…Ù† Ø§Ù„Ø³Ù‡Ù…`, 1000);
            renderBoard();
        }

        function useBomb(row, col) {
            let level = levels[currentLevel];
            let rows = board.length, cols = board[0].length;
            let points = 0;

            for (let r = Math.max(0, row-1); r <= Math.min(rows-1, row+1); r++) {
                for (let c = Math.max(0, col-1); c <= Math.min(cols-1, col+1); c++) {
                    if (!level.obstacles.some(o => o.row === r && o.col === c)) {
                        points += board[r][c];
                        board[r][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                    }
                }
            }

            score += points;
            boosters.bomb--;
            showMessage(`â• ${points} Ù†Ù‚Ø·Ø© Ù…Ù† Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©`, 1000);
            renderBoard();
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ------------------------------------------------------------
        function useHint() {
            if (score < 30) {
                showMessage('âŒ Ø§Ù„Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ©', 1500);
                return;
            }

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ø±ÙƒØ© Ù…ÙÙŠØ¯Ø©
            for (let r = 0; r < board.length; r++) {
                for (let c = 0; c < board[0].length; c++) {
                    if (c + 1 < board[0].length) {
                        [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                        if (checkMatches(board).matches.length > 0) {
                            [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                            highlightCell(r, c);
                            score -= 30;
                            renderBoard();
                            return;
                        }
                        [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                    }
                    
                    if (r + 1 < board.length) {
                        [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                        if (checkMatches(board).matches.length > 0) {
                            [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                            highlightCell(r, c);
                            score -= 30;
                            renderBoard();
                            return;
                        }
                        [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                    }
                }
            }
            
            showMessage('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ© Ù…ØªØ§Ø­Ø©', 1500);
        }

        function highlightCell(r, c) {
            let index = r * board[0].length + c;
            document.querySelectorAll('.cell')[index]?.classList.add('hint');
            setTimeout(() => {
                document.querySelectorAll('.cell').forEach(el => el.classList.remove('hint'));
            }, 2000);
        }

        // ------------------------------------------------------------
        //                     Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        // ------------------------------------------------------------
        function showMessage(text, duration = 2000) {
            let msg = document.getElementById('messagePopup');
            msg.style.display = 'block';
            msg.textContent = text;
            setTimeout(() => msg.style.display = 'none', duration);
        }

        // ------------------------------------------------------------
        //                     ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        // ------------------------------------------------------------
        function renderBoard() {
            let level = levels[currentLevel];
            let boardDiv = document.getElementById('board');

            document.getElementById('levelDisplay').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${level.id}`;
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('arrowCount').textContent = boosters.arrow;
            document.getElementById('bombCount').textContent = boosters.bomb;

            document.getElementById('prevBtn').classList.toggle('disabled', currentLevel === 0);
            document.getElementById('nextBtn').classList.toggle('disabled', 
                currentLevel === levels.length-1 || !completedLevels.includes(currentLevel));

            boardDiv.style.gridTemplateColumns = `repeat(${level.cols}, 70px)`;
            boardDiv.innerHTML = '';

            for (let r = 0; r < level.rows; r++) {
                for (let c = 0; c < level.cols; c++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';

                    if (level.obstacles.some(o => o.row === r && o.col === c)) {
                        cell.classList.add('obstacle');
                    } else {
                        let num = board[r][c];
                        cell.textContent = num;
                        cell.classList.add(`num-${num}`);
                        
                        if (level.ice.some(i => i.row === r && i.col === c)) {
                            cell.classList.add('ice');
                        }
                    }

                    if (selectedRow === r && selectedCol === c) {
                        cell.classList.add('selected');
                    }

                    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ­Ø±ÙŠÙƒ (Ø§Ù„Ø·Ø±ÙŠÙ‚ØªÙŠÙ†)
                    cell.onclick = () => handleCellInteraction(r, c, false);
                    
                    cell.setAttribute('draggable', 'true');
                    cell.ondragstart = (e) => {
                        e.dataTransfer.setData('text/plain', '');
                        handleCellInteraction(r, c, true);
                    };
                    cell.ondragover = (e) => e.preventDefault();
                    cell.ondrop = (e) => {
                        e.preventDefault();
                        handleCellInteraction(r, c, true);
                    };

                    boardDiv.appendChild(cell);
                }
            }
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        // ------------------------------------------------------------
        function nextLevel() {
            if (currentLevel < levels.length - 1 && completedLevels.includes(currentLevel)) {
                currentLevel++;
                resetLevel();
            } else {
                showMessage('âŒ Ù„Ù… ØªØ­Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¨Ø¹Ø¯', 1500);
            }
        }

        function prevLevel() {
            if (currentLevel > 0) {
                currentLevel--;
                resetLevel();
            }
        }

        function resetLevel() {
            let level = levels[currentLevel];
            updateNumbersPool(level);
            board = createRandomBoard(level.rows, level.cols);
            score = 0;
            selectedRow = -1;
            selectedBooster = null;
            boosters = { 
                arrow: level.id <= 3 ? 3 : level.id <= 5 ? 2 : 1,
                bomb: level.id <= 3 ? 2 : level.id <= 5 ? 1 : 0
            };
            renderBoard();
        }

        // ------------------------------------------------------------
        //                     Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        // ------------------------------------------------------------
        resetLevel();
    </script>
</body>
</html>
