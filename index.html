<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at 50% 50%, #1a1a2e, #0f0f1a);
            padding: 20px;
        }

        .game-container {
            background: linear-gradient(145deg, #2a2a4a, #1a1a3a);
            border-radius: 60px;
            padding: 30px;
            box-shadow: 0 30px 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(255,255,255,0.1);
            max-width: 800px;
            width: 100%;
            border: 3px solid gold;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¹ Ø§Ù„Ù†Ø¬ÙˆÙ… */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .level-box {
            background: linear-gradient(145deg, #4a2a6a, #2a1a4a);
            padding: 10px 25px;
            border-radius: 40px;
            border: 2px solid gold;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        .level-text {
            color: gold;
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px #ffaa00;
        }

        .stars-box {
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 30px;
        }

        .star {
            font-size: 35px;
            color: #444;
            transition: 0.3s;
            filter: drop-shadow(0 0 5px gold);
        }

        .star.active {
            color: gold;
            text-shadow: 0 0 20px orange;
        }

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-panel {
            display: flex;
            justify-content: space-around;
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border-radius: 50px;
            margin-bottom: 25px;
            border: 2px solid #4a2a6a;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 40px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 15px orange;
        }

        .stat-label {
            color: #aaa;
            font-size: 16px;
        }

        /* Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª */
        .boosters-panel {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .booster {
            width: 90px;
            height: 90px;
            background: radial-gradient(circle at 30% 30%, #ffd966, #b8860b);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid gold;
            box-shadow: 0 10px 0 #8b6508, 0 15px 20px black;
            cursor: pointer;
            transition: 0.1s;
        }

        .booster:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #8b6508, 0 10px 15px black;
        }

        .booster.disabled {
            opacity: 0.5;
            filter: grayscale(1);
            pointer-events: none;
        }

        .booster-icon {
            font-size: 40px;
        }

        .booster-count {
            background: #2a1a4a;
            color: gold;
            padding: 2px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        .board-wrapper {
            background: #2a1a4a;
            padding: 30px;
            border-radius: 70px;
            border: 4px solid gold;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
            margin-bottom: 25px;
        }

        .board {
            display: inline-grid;
            gap: 8px;
            justify-content: center;
            width: 100%;
        }

        /* Ø§Ù„Ø®Ù„Ø§ÙŠØ§ - ØªØµÙ…ÙŠÙ… Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ */
        .cell {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            box-shadow: 0 8px 0 rgba(0,0,0,0.3), 0 12px 20px rgba(0,0,0,0.4);
            cursor: grab;
            transition: 0.1s;
            position: relative;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .cell:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
        .num-1 { background: radial-gradient(circle at 30% 30%, #ff4d4d, #b30000); }  /* Ø£Ø­Ù…Ø± */
        .num-2 { background: radial-gradient(circle at 30% 30%, #4dff4d, #00b300); }  /* Ø£Ø®Ø¶Ø± */
        .num-3 { background: radial-gradient(circle at 30% 30%, #4d4dff, #0000b3); }  /* Ø£Ø²Ø±Ù‚ */
        .num-4 { background: radial-gradient(circle at 30% 30%, #ff4dff, #b300b3); }  /* ÙˆØ±Ø¯ÙŠ */
        .num-5 { background: radial-gradient(circle at 30% 30%, #ffff4d, #b3b300); }  /* Ø£ØµÙØ± */
        .num-6 { background: radial-gradient(circle at 30% 30%, #ffaa4d, #b35f00); }  /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */

        .cell.obstacle {
            background: radial-gradient(circle at 30% 30%, #7f8c8d, #2c3e50);
            cursor: not-allowed;
            box-shadow: 0 5px 0 #1a1a1a;
        }

        .cell.obstacle::after {
            content: "â›”";
            font-size: 35px;
            opacity: 0.7;
        }

        .cell.ice {
            position: relative;
        }

        .cell.ice::after {
            content: "â„ï¸";
            position: absolute;
            top: -12px;
            right: -12px;
            font-size: 28px;
            filter: drop-shadow(0 0 5px cyan);
        }

        .cell.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 6px gold, 0 8px 0 rgba(0,0,0,0.3), 0 15px 25px black;
            z-index: 100;
        }

        @keyframes matchPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); filter: brightness(1.5); }
            100% { transform: scale(0); }
        }

        .cell.matching {
            animation: matchPop 0.3s ease forwards;
        }

        @keyframes shake {
            0%,100% { transform: translateX(0); }
            25% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }

        .cell.error {
            animation: shake 0.2s;
        }

        /* Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© */
        .hint-button {
            background: linear-gradient(145deg, #4a2a6a, #2a1a4a);
            border: 3px solid gold;
            color: gold;
            font-size: 24px;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 0 auto 25px;
            width: fit-content;
            transition: 0.1s;
            box-shadow: 0 10px 0 #1a0f2a;
        }

        .hint-button:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #1a0f2a;
        }

        .hint-button.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .hint-icon {
            background: gold;
            color: #2a1a4a;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .cell.hint {
            animation: hintGlow 1s infinite;
            box-shadow: 0 0 0 6px cyan, 0 8px 0 rgba(0,0,0,0.3), 0 15px 25px black;
        }

        @keyframes hintGlow {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            background: linear-gradient(145deg, #4a2a6a, #2a1a4a);
            border: 3px solid gold;
            color: gold;
            font-size: 28px;
            padding: 15px 30px;
            border-radius: 60px;
            cursor: pointer;
            transition: 0.1s;
            box-shadow: 0 10px 0 #1a0f2a;
            flex: 1;
            max-width: 200px;
            text-align: center;
        }

        .nav-btn:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #1a0f2a;
        }

        .nav-btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Ø±Ø³Ø§Ø¦Ù„ */
        .floating-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, gold, orange);
            color: #2a1a4a;
            padding: 30px 60px;
            border-radius: 80px;
            font-size: 48px;
            font-weight: bold;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
            display: none;
            z-index: 1000;
            animation: floatIn 0.5s;
            border: 5px solid white;
        }

        @keyframes floatIn {
            0% { transform: translate(-50%, -30%); opacity: 0; }
            100% { transform: translate(-50%, -50%); opacity: 1; }
        }

        .score-pop {
            position: absolute;
            color: gold;
            font-size: 30px;
            font-weight: bold;
            pointer-events: none;
            animation: popUp 1s forwards;
        }

        @keyframes popUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¹ Ø§Ù„Ù†Ø¬ÙˆÙ… -->
        <div class="header">
            <div class="level-box">
                <span class="level-text" id="levelDisplay">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</span>
            </div>
            <div class="stars-box" id="starsContainer">
                <span class="star" id="star1">â˜…</span>
                <span class="star" id="star2">â˜…</span>
                <span class="star" id="star3">â˜…</span>
            </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div class="stats-panel">
            <div class="stat">
                <div class="stat-value" id="scoreDisplay">0</div>
                <div class="stat-label">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="targetDisplay">500</div>
                <div class="stat-label">Ø§Ù„Ù‡Ø¯Ù</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="movesDisplay">0</div>
                <div class="stat-label">Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª -->
        <div class="boosters-panel">
            <div class="booster" onclick="useBooster('arrow')" id="boosterArrow">
                <div class="booster-icon">â¬…ï¸â¡ï¸</div>
                <div class="booster-count" id="arrowCount">0</div>
            </div>
            <div class="booster" onclick="useBooster('bomb')" id="boosterBomb">
                <div class="booster-icon">ğŸ’£</div>
                <div class="booster-count" id="bombCount">0</div>
            </div>
        </div>

        <!-- Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© -->
        <div class="hint-button" onclick="useHint()" id="hintBtn">
            <span class="hint-icon">ğŸ’¡</span>
            <span>Ù…Ø³Ø§Ø¹Ø¯Ø© (50 Ù†Ù‚Ø·Ø©)</span>
            <span id="hintCost">50</span>
        </div>

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨ -->
        <div class="board-wrapper">
            <div class="board" id="board"></div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <div class="nav-buttons">
            <div class="nav-btn" onclick="prevLevel()" id="prevBtn">â—€ Ø±Ø¬ÙˆØ¹</div>
            <div class="nav-btn" onclick="resetLevel()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</div>
            <div class="nav-btn" onclick="nextLevel()" id="nextBtn">ØªØ§Ù„ÙŠ â–¶</div>
        </div>
    </div>

    <!-- Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div class="floating-message" id="messageBox"></div>

    <script>
        // ------------------------------------------------------------
        //                     Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©
        // ------------------------------------------------------------

        // Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØ§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©
        let completedLevels = JSON.parse(localStorage.getItem('completedLevels')) || [];
        let levelStars = JSON.parse(localStorage.getItem('levelStars')) || {};

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let currentLevel = 0;
        let board = [];
        let score = 0;
        let moves = 0;
        let selectedRow = -1, selectedCol = -1;
        let boosters = { arrow: 0, bomb: 0 };
        let gameActive = true;
        let hintActive = false;
        let numbersPool = [];

        // ------------------------------------------------------------
        //                     ØªÙˆÙ„ÙŠØ¯ 20 Ù…Ø±Ø­Ù„Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©
        // ------------------------------------------------------------
        function generateLevels() {
            let levels = [];
            for (let i = 1; i <= 20; i++) {
                let uniqueNumbers, obstacleCount, iceCount, target;
                
                if (i <= 3) {
                    uniqueNumbers = 3;  // Ø£Ø±Ù‚Ø§Ù… 1-3
                    obstacleCount = 0;
                    iceCount = 0;
                    target = 300 + i * 50;
                } else if (i <= 5) {
                    uniqueNumbers = 4;  // Ø£Ø±Ù‚Ø§Ù… 1-4
                    obstacleCount = 2 + i;
                    iceCount = 1;
                    target = 500 + i * 60;
                } else if (i <= 10) {
                    uniqueNumbers = 5;  // Ø£Ø±Ù‚Ø§Ù… 1-5
                    obstacleCount = 4 + i;
                    iceCount = 2;
                    target = 800 + i * 70;
                } else {
                    uniqueNumbers = 6;  // Ø£Ø±Ù‚Ø§Ù… 1-6
                    obstacleCount = 6 + i;
                    iceCount = 3;
                    target = 1200 + i * 80;
                }

                levels.push({
                    id: i,
                    rows: i > 15 ? 7 : 6,
                    cols: i > 15 ? 7 : 6,
                    target: target,
                    uniqueNumbers: uniqueNumbers,
                    obstacles: generateObstacles(obstacleCount, i > 15 ? 7 : 6, i > 15 ? 7 : 6),
                    ice: generateIce(iceCount, i > 15 ? 7 : 6, i > 15 ? 7 : 6),
                    arrowRate: i <= 3 ? 0.8 : i <= 5 ? 0.4 : 0.2,
                    bombRate: i <= 3 ? 0.6 : i <= 5 ? 0.3 : 0.1,
                    shape: i > 12 ? 'triangle' : 'square'
                });
            }
            return levels;
        }

        function generateObstacles(count, rows, cols) {
            let obs = [];
            for (let i = 0; i < count; i++) {
                obs.push({ row: Math.floor(Math.random() * rows), col: Math.floor(Math.random() * cols) });
            }
            return obs;
        }

        function generateIce(count, rows, cols) {
            let ice = [];
            for (let i = 0; i < count; i++) {
                ice.push({ row: Math.floor(Math.random() * rows), col: Math.floor(Math.random() * cols), layers: 2 });
            }
            return ice;
        }

        const levels = generateLevels();

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
        function updateNumbersPool(level) {
            numbersPool = [];
            for (let i = 1; i <= level.uniqueNumbers; i++) numbersPool.push(i);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        function createRandomBoard(rows, cols) {
            let b = [];
            for (let r = 0; r < rows; r++) {
                let row = [];
                for (let c = 0; c < cols; c++) {
                    row.push(numbersPool[Math.floor(Math.random() * numbersPool.length)]);
                }
                b.push(row);
            }
            return b;
        }

        // ------------------------------------------------------------
        //                     Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø¬ÙˆÙ…
        // ------------------------------------------------------------
        function updateStars() {
            let stars = levelStars[currentLevel] || 0;
            for (let i = 1; i <= 3; i++) {
                let star = document.getElementById(`star${i}`);
                if (i <= stars) star.classList.add('active');
                else star.classList.remove('active');
            }
        }

        function calculateStars() {
            let level = levels[currentLevel];
            let percent = (score / level.target) * 100;
            let stars = 0;
            if (percent >= 100) stars = 1;
            if (percent >= 150) stars = 2;
            if (percent >= 200) stars = 3;
            
            if (stars > 0 && !completedLevels.includes(currentLevel)) {
                completedLevels.push(currentLevel);
                levelStars[currentLevel] = stars;
                localStorage.setItem('completedLevels', JSON.stringify(completedLevels));
                localStorage.setItem('levelStars', JSON.stringify(levelStars));
                showMessage(`ğŸŒŸ ÙØ²Øª Ø¨Ù€ ${stars} Ù†Ø¬ÙˆÙ…!`);
            }
            updateStars();
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª
        // ------------------------------------------------------------
        function checkMatches(board) {
            let matches = [], lengths = [];
            let rows = board.length, cols = board[0].length;

            // Ø£ÙÙ‚ÙŠ
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols - 2; c++) {
                    if (board[r][c] && board[r][c+1] && board[r][c+2] && 
                        board[r][c] === board[r][c+1] && board[r][c] === board[r][c+2]) {
                        
                        let len = 3;
                        if (c+3 < cols && board[r][c] === board[r][c+3]) {
                            len = 4;
                            if (c+4 < cols && board[r][c] === board[r][c+4]) len = 5;
                        }
                        
                        for (let i = 0; i < len; i++) {
                            matches.push([r, c+i]);
                            lengths.push({ row: r, col: c+i, length: len });
                        }
                    }
                }
            }

            // Ø¹Ù…ÙˆØ¯ÙŠ
            for (let c = 0; c < cols; c++) {
                for (let r = 0; r < rows - 2; r++) {
                    if (board[r][c] && board[r+1][c] && board[r+2][c] && 
                        board[r][c] === board[r+1][c] && board[r][c] === board[r+2][c]) {
                        
                        let len = 3;
                        if (r+3 < rows && board[r][c] === board[r+3][c]) {
                            len = 4;
                            if (r+4 < rows && board[r][c] === board[r+4][c]) len = 5;
                        }
                        
                        for (let i = 0; i < len; i++) {
                            matches.push([r+i, c]);
                            lengths.push({ row: r+i, col: c, length: len });
                        }
                    }
                }
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
            matches = [...new Set(matches.map(JSON.stringify))].map(JSON.parse);
            return { matches, matchLengths: lengths };
        }

        // ------------------------------------------------------------
        //                     Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø¹Ø²Ø²Ø§Øª
        // ------------------------------------------------------------
        function removeMatches(board, matches, matchLengths) {
            let level = levels[currentLevel];
            let rows = board.length, cols = board[0].length;
            let removed = Array(rows).fill().map(() => Array(cols).fill(false));

            matches.forEach(([r, c]) => {
                removed[r][c] = true;
                let info = matchLengths.find(m => m.row === r && m.col === c);
                if (info) {
                    if (info.length === 4 && Math.random() < level.arrowRate) {
                        boosters.arrow++;
                        animateBooster('arrow');
                    } else if (info.length === 5 && Math.random() < level.bombRate) {
                        boosters.bomb++;
                        animateBooster('bomb');
                    }
                }
            });

            // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
            let points = matches.length * 10;
            score += points;
            showScorePop(points);

            // Ø¥Ø³Ù‚Ø§Ø· Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            for (let c = 0; c < cols; c++) {
                for (let r = rows-1; r >= 0; r--) {
                    if (removed[r][c]) {
                        for (let k = r-1; k >= 0; k--) {
                            if (!removed[k][c]) {
                                board[r][c] = board[k][c];
                                removed[k][c] = true;
                                removed[r][c] = false;
                                break;
                            }
                        }
                        if (removed[r][c]) {
                            board[r][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                        }
                    }
                }
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ²
            if (score >= level.target) {
                calculateStars();
            }
        }

        // ------------------------------------------------------------
        //                     Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
        // ------------------------------------------------------------
        function handleDragStart(r, c) {
            if (!gameActive) return;
            let level = levels[currentLevel];
            if (level.obstacles.some(o => o.row === r && o.col === c)) return;
            
            selectedRow = r;
            selectedCol = c;
            renderBoard();
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(r, c) {
            e.preventDefault();
            if (!gameActive || selectedRow === -1) return;

            let level = levels[currentLevel];
            if (level.obstacles.some(o => o.row === r && o.col === c)) {
                selectedRow = -1;
                renderBoard();
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¬Ø§ÙˆØ±
            if (Math.abs(r - selectedRow) + Math.abs(c - selectedCol) !== 1) {
                selectedRow = -1;
                renderBoard();
                return;
            }

            // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø®Ù„ÙŠØªÙŠÙ†
            let temp = board[r][c];
            board[r][c] = board[selectedRow][selectedCol];
            board[selectedRow][selectedCol] = temp;

            moves++;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ·Ø§Ø¨Ù‚Ø§Øª
            let { matches, matchLengths } = checkMatches(board);
            
            if (matches.length > 0) {
                removeMatches(board, matches, matchLengths);
                
                // Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„Ø©
                let more;
                do {
                    let res = checkMatches(board);
                    more = res.matches;
                    if (more.length) {
                        removeMatches(board, more, res.matchLengths);
                    }
                } while (more.length);
            } else {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚
                let temp = board[r][c];
                board[r][c] = board[selectedRow][selectedCol];
                board[selectedRow][selectedCol] = temp;
                moves--;
                
                // ØªØ£Ø«ÙŠØ± Ø®Ø·Ø£
                let cells = document.querySelectorAll('.cell');
                cells.forEach(c => c.classList.add('error'));
                setTimeout(() => cells.forEach(c => c.classList.remove('error')), 200);
            }

            selectedRow = -1;
            renderBoard();
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ------------------------------------------------------------
        function useHint() {
            if (score < 50) {
                showMessage('âŒ Ø§Ù„Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ©!');
                return;
            }

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²ÙˆØ¬ ÙŠØ¹Ø·ÙŠ ØªØ·Ø§Ø¨Ù‚
            for (let r = 0; r < board.length; r++) {
                for (let c = 0; c < board[0].length; c++) {
                    // Ø¬Ø±Ø¨ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙÙ‚ÙŠ
                    if (c + 1 < board[0].length) {
                        [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                        if (checkMatches(board).matches.length > 0) {
                            [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                            highlightCell(r, c);
                            score -= 50;
                            renderBoard();
                            return;
                        }
                        [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                    }
                    
                    // Ø¬Ø±Ø¨ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ
                    if (r + 1 < board.length) {
                        [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                        if (checkMatches(board).matches.length > 0) {
                            [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                            highlightCell(r, c);
                            score -= 50;
                            renderBoard();
                            return;
                        }
                        [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                    }
                }
            }
            
            showMessage('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ© Ù…ØªØ§Ø­Ø©!');
        }

        function highlightCell(r, c) {
            let index = r * board[0].length + c;
            document.querySelectorAll('.cell')[index]?.classList.add('hint');
            setTimeout(() => {
                document.querySelectorAll('.cell').forEach(el => el.classList.remove('hint'));
            }, 2000);
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª
        // ------------------------------------------------------------
        function useBooster(type) {
            if (boosters[type] <= 0) return;

            if (type === 'arrow') {
                showMessage('â¬…ï¸â¡ï¸ Ø§Ø®ØªØ± ØµÙ Ø£Ùˆ Ø¹Ù…ÙˆØ¯');
                // Ù‡Ù†Ø§ Ù…Ù†Ø·Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ/Ø§Ù„Ø¹Ù…ÙˆØ¯
            } else if (type === 'bomb') {
                showMessage('ğŸ’£ Ø§Ø®ØªØ± Ø®Ù„ÙŠØ© Ù„Ù„Ù‚Ù†Ø¨Ù„Ø©');
                // Ù‡Ù†Ø§ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
            }
        }

        function animateBooster(type) {
            let el = document.getElementById(`booster${type.charAt(0).toUpperCase() + type.slice(1)}`);
            el.style.transform = 'scale(1.3)';
            setTimeout(() => el.style.transform = 'scale(1)', 200);
        }

        // ------------------------------------------------------------
        //                     Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        // ------------------------------------------------------------
        function showMessage(text) {
            let msg = document.getElementById('messageBox');
            msg.style.display = 'block';
            msg.textContent = text;
            setTimeout(() => msg.style.display = 'none', 2000);
        }

        function showScorePop(points) {
            let pop = document.createElement('div');
            pop.className = 'score-pop';
            pop.textContent = `+${points}`;
            pop.style.left = '50%';
            pop.style.top = '50%';
            document.body.appendChild(pop);
            setTimeout(() => pop.remove(), 1000);
        }

        // ------------------------------------------------------------
        //                     ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        // ------------------------------------------------------------
        function renderBoard() {
            let level = levels[currentLevel];
            let boardDiv = document.getElementById('board');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            document.getElementById('levelDisplay').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${level.id}`;
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('targetDisplay').textContent = level.target;
            document.getElementById('movesDisplay').textContent = moves;
            document.getElementById('arrowCount').textContent = boosters.arrow;
            document.getElementById('bombCount').textContent = boosters.bomb;

            // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
            document.getElementById('prevBtn').classList.toggle('disabled', currentLevel === 0);
            document.getElementById('nextBtn').classList.toggle('disabled', 
                currentLevel === levels.length-1 || !completedLevels.includes(currentLevel));

            // Ø¶Ø¨Ø· Ø´ÙƒÙ„ Ø§Ù„Ø´Ø¨ÙƒØ©
            boardDiv.style.gridTemplateColumns = `repeat(${level.cols}, 70px)`;
            boardDiv.innerHTML = '';

            // Ø±Ø³Ù… Ø§Ù„Ø®Ù„Ø§ÙŠØ§
            for (let r = 0; r < level.rows; r++) {
                for (let c = 0; c < level.cols; c++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';

                    // Ø´ÙƒÙ„ Ø§Ù„Ù…Ø«Ù„Ø«
                    if (level.shape === 'triangle' && c > r) {
                        cell.classList.add('obstacle');
                    } else {
                        // ØµØ®ÙˆØ±
                        if (level.obstacles.some(o => o.row === r && o.col === c)) {
                            cell.classList.add('obstacle');
                        } else {
                            let num = board[r][c];
                            cell.textContent = num;
                            cell.classList.add(`num-${num}`);
                            
                            // Ø¬Ù„ÙŠØ¯
                            if (level.ice.some(i => i.row === r && i.col === c)) {
                                cell.classList.add('ice');
                            }
                        }
                    }

                    if (selectedRow === r && selectedCol === c) {
                        cell.classList.add('selected');
                    }

                    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø­Ø¨
                    cell.setAttribute('draggable', 'true');
                    cell.ondragstart = (e) => {
                        e.dataTransfer.setData('text/plain', '');
                        handleDragStart(r, c);
                    };
                    cell.ondragover = (e) => e.preventDefault();
                    cell.ondrop = (e) => {
                        e.preventDefault();
                        handleDrop(r, c);
                    };

                    boardDiv.appendChild(cell);
                }
            }

            updateStars();
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        // ------------------------------------------------------------
        function nextLevel() {
            if (currentLevel < levels.length - 1 && completedLevels.includes(currentLevel)) {
                currentLevel++;
                resetLevel();
            } else {
                showMessage('âŒ Ù„Ù… ØªØ­Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¨Ø¹Ø¯!');
            }
        }

        function prevLevel() {
            if (currentLevel > 0) {
                currentLevel--;
                resetLevel();
            }
        }

        function resetLevel() {
            let level = levels[currentLevel];
            updateNumbersPool(level);
            board = createRandomBoard(level.rows, level.cols);
            score = 0;
            moves = 0;
            selectedRow = -1;
            gameActive = true;
            boosters = { 
                arrow: level.id <= 3 ? 3 : level.id <= 5 ? 2 : 1,
                bomb: level.id <= 3 ? 2 : level.id <= 5 ? 1 : 0
            };
            renderBoard();
        }

        // ------------------------------------------------------------
        //                     Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        // ------------------------------------------------------------
        resetLevel();
    </script>
</body>
</html>
