<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>محرك التطابق الاحترافي v2.0</title>
    <style>
        body {
            margin: 0; background: #050510; color: white;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        canvas {
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
            border: 4px solid #d4af37; border-radius: 15px;
            cursor: pointer; margin-top: 20px;
        }
        .stats {
            margin-top: 20px; font-size: 24px; font-weight: bold;
            color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
    </style>
</head>
<body>
    <div class="stats">النقاط: <span id="score">0</span></div>
    <canvas id="gameCanvas"></canvas>

<script>
/**
 * نظام الجسيمات (Particle System) للانفجارات
 */
class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y;
        this.color = color;
        this.size = Math.random() * 5 + 2;
        this.speedX = Math.random() * 6 - 3;
        this.speedY = Math.random() * 6 - 3;
        this.life = 1.0;
    }
    update() {
        this.x += this.speedX;
        this.y += this.speedY;
        this.life -= 0.02;
    }
    draw(ctx) {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');

// الإعدادات العالمية
const GRID_SIZE = 8;
const CELL_SIZE = 60;
const COLORS = ['#FFD700', '#FF5555', '#55FF55', '#5555FF', '#FF55FF', '#55FFFF'];
canvas.width = GRID_SIZE * CELL_SIZE;
canvas.height = GRID_SIZE * CELL_SIZE;

let grid = [];
let particles = [];
let score = 0;
let isSwapping = false;

// تهيئة الشبكة
function initGrid() {
    for (let r = 0; r < GRID_SIZE; r++) {
        grid[r] = [];
        for (let c = 0; c < GRID_SIZE; c++) {
            grid[r][c] = {
                val: Math.floor(Math.random() * COLORS.length),
                y: r * CELL_SIZE,
                targetY: r * CELL_SIZE,
                offsetY: 0
            };
        }
    }
}

/**
 * محرك الرسم الرئيسي (Game Loop)
 */
function update() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // رسم الشبكة الخلفية
    ctx.strokeStyle = '#1a1a3a';
    for(let i=0; i<=GRID_SIZE; i++) {
        ctx.beginPath(); ctx.moveTo(i*CELL_SIZE, 0); ctx.lineTo(i*CELL_SIZE, canvas.height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, i*CELL_SIZE); ctx.lineTo(canvas.width, i*CELL_SIZE); ctx.stroke();
    }

    // تحديث ورسم العناصر
    grid.forEach((row, r) => {
        row.forEach((cell, c) => {
            // تحريك ناعم (Interpolation)
            if (cell.y < cell.targetY) cell.y += 5; 
            
            drawCoin(c * CELL_SIZE + CELL_SIZE/2, cell.y + CELL_SIZE/2, COLORS[cell.val]);
        });
    });

    // تحديث الجسيمات
    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => { p.update(); p.draw(ctx); });

    requestAnimationFrame(update);
}

function drawCoin(x, y, color) {
    ctx.globalAlpha = 1.0;
    // الظل
    ctx.shadowBlur = 15; ctx.shadowColor = color;
    // الجسم
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, CELL_SIZE/2 - 5, 0, Math.PI * 2);
    ctx.fill();
    // لمعة احترافية
    ctx.shadowBlur = 0;
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.beginPath();
    ctx.arc(x - 10, y - 10, 5, 0, Math.PI * 2);
    ctx.fill();
}

// تفاعل المستخدم
canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const c = Math.floor(x / CELL_SIZE);
    const r = Math.floor(y / CELL_SIZE);
    
    createExplosion(x, y, COLORS[grid[r][c].val]);
    checkMatches();
};

function createExplosion(x, y, color) {
    for (let i = 0; i < 15; i++) {
        particles.push(new Particle(x, y, color));
    }
}

function checkMatches() {
    // منطق متطور للبحث عن التطابقات وإسقاط العناصر
    // (يتم هنا إضافة خوارزمية التدمير المتسلسل)
    score += 100;
    scoreEl.innerText = score;
}

initGrid();
update();
</script>
</body>
</html>
