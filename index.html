<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at 50% 50%, #0a0a1a, #000010);
            padding: 15px;
        }

        .game-container {
            background: linear-gradient(145deg, #1a1a3a, #0a0a2a);
            border-radius: 60px;
            padding: 25px;
            box-shadow: 0 30px 50px rgba(0,0,0,0.9), inset 0 0 30px rgba(255,215,0,0.2);
            max-width: 800px;
            width: 100%;
            border: 4px solid gold;
            position: relative;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.6);
            padding: 15px 25px;
            border-radius: 50px;
            border: 2px solid gold;
        }

        .level-box {
            background: linear-gradient(145deg, gold, orange);
            color: #1a1a3a;
            padding: 10px 30px;
            border-radius: 40px;
            font-size: 28px;
            font-weight: bold;
            box-shadow: inset 0 -3px 0 #b8860b;
        }

        .score-box {
            background: #2a1a4a;
            color: gold;
            padding: 10px 30px;
            border-radius: 40px;
            font-size: 28px;
            font-weight: bold;
            border: 2px solid gold;
        }

        /* Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª */
        .boosters-panel {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 25px;
        }

        .booster {
            width: 90px;
            height: 90px;
            background: radial-gradient(circle at 30% 30%, #ffd966, #b8860b);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid gold;
            box-shadow: 0 8px 0 #8b6508;
            cursor: pointer;
            transition: 0.05s;
        }

        .booster:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #8b6508;
        }

        .booster.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .booster-icon {
            font-size: 36px;
        }

        .booster-count {
            background: #1a1a3a;
            color: gold;
            padding: 2px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        .board-wrapper {
            background: #2a1a4a;
            padding: 25px;
            border-radius: 60px;
            border: 4px solid gold;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .board {
            display: inline-grid;
            gap: 8px;
            justify-content: center;
            width: 100%;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù†ÙŠØ© */
        .cell {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ffd700, #b8860b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #1a1a2e;
            text-shadow: 0 2px 5px rgba(255,255,255,0.5);
            box-shadow: 0 8px 0 #8b6508, 0 10px 20px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: 0.05s;
            border: 3px solid #ffd700;
            position: relative;
            z-index: 2;
        }

        .cell.selected {
            transform: scale(1.1);
            box-shadow: 0 0 0 6px gold, 0 8px 0 #8b6508, 0 15px 25px black;
            z-index: 100;
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
        .num-1 { background: radial-gradient(circle at 35% 35%, #ffb3b3, #ff4d4d); }
        .num-2 { background: radial-gradient(circle at 35% 35%, #b3ffb3, #4dff4d); }
        .num-3 { background: radial-gradient(circle at 35% 35%, #b3b3ff, #4d4dff); }
        .num-4 { background: radial-gradient(circle at 35% 35%, #ffb3ff, #ff4dff); }
        .num-5 { background: radial-gradient(circle at 35% 35%, #ffffb3, #ffff4d); }
        .num-6 { background: radial-gradient(circle at 35% 35%, #ffd9b3, #ffaa4d); }

        /* Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª */
        .cell.obstacle {
            background: radial-gradient(circle at 35% 35%, #95a5a6, #4a4a4a);
            box-shadow: 0 5px 0 #2c3e50;
            border-color: #7f8c8d;
            cursor: not-allowed;
        }

        .cell.obstacle::after {
            content: "â›”";
            position: absolute;
            font-size: 30px;
            color: white;
            text-shadow: 0 2px 5px black;
        }

        .cell.ice {
            position: relative;
        }

        .cell.ice::after {
            content: "â„ï¸";
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            filter: drop-shadow(0 0 5px cyan);
        }

        /* Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .booster-piece {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            z-index: 200;
            pointer-events: auto;
            cursor: pointer;
            animation: appear 0.3s;
        }

        .booster-piece.arrow {
            background: radial-gradient(circle at 35% 35%, gold, orange);
            border: 4px solid white;
            box-shadow: 0 0 30px gold;
        }

        .booster-piece.bomb {
            background: radial-gradient(circle at 35% 35%, #ff4d4d, #b30000);
            border: 4px solid white;
            box-shadow: 0 0 30px red;
        }

        @keyframes appear {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes matchPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); filter: brightness(1.8); }
            100% { transform: scale(0); opacity: 0; }
        }

        .cell.matching {
            animation: matchPop 0.2s ease forwards;
            pointer-events: none;
        }

        @keyframes shake {
            0%,100% { transform: translateX(0); }
            25% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }

        .cell.error {
            animation: shake 0.2s;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ÙÙˆØ² */
        .victory-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 60px;
        }

        .victory-content {
            background: linear-gradient(145deg, gold, orange);
            padding: 50px;
            border-radius: 80px;
            text-align: center;
            color: #1a1a3a;
            border: 5px solid white;
            box-shadow: 0 30px 50px rgba(0,0,0,0.8);
        }

        .victory-content h1 {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .victory-content button {
            background: #1a1a3a;
            color: gold;
            border: none;
            padding: 20px 50px;
            font-size: 32px;
            border-radius: 60px;
            cursor: pointer;
            margin-top: 30px;
            border: 3px solid white;
        }

        /* Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© */
        .hint-btn {
            background: linear-gradient(145deg, gold, orange);
            color: #1a1a2e;
            font-size: 24px;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 0 auto 20px;
            width: fit-content;
            box-shadow: 0 8px 0 #b8860b;
            transition: 0.05s;
        }

        .hint-btn:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #b8860b;
        }

        .cell.hint {
            animation: hintPulse 0.8s infinite;
            box-shadow: 0 0 0 6px cyan, 0 8px 0 #8b6508, 0 15px 25px black;
        }

        @keyframes hintPulse {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .nav-btn {
            background: linear-gradient(145deg, #4a2a6a, #2a1a4a);
            border: 3px solid gold;
            color: gold;
            font-size: 24px;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.05s;
            box-shadow: 0 6px 0 #1a0f2a;
            flex: 1;
            max-width: 180px;
            text-align: center;
        }

        .nav-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1a0f2a;
        }

        .nav-btn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, gold, orange);
            color: #1a1a2e;
            padding: 30px 50px;
            border-radius: 60px;
            font-size: 36px;
            font-weight: bold;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
            display: none;
            z-index: 2000;
            border: 5px solid white;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="header">
            <div class="level-box" id="levelDisplay">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</div>
            <div class="score-box" id="scoreDisplay">0</div>
        </div>

        <!-- Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª -->
        <div class="boosters-panel">
            <div class="booster" onclick="useBooster('arrow')" id="boosterArrow">
                <div class="booster-icon">â¬…ï¸â¡ï¸</div>
                <div class="booster-count" id="arrowCount">0</div>
            </div>
            <div class="booster" onclick="useBooster('bomb')" id="boosterBomb">
                <div class="booster-icon">ğŸ’£</div>
                <div class="booster-count" id="bombCount">0</div>
            </div>
        </div>

        <!-- Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© -->
        <button class="hint-btn" onclick="useHint()">
            <span>ğŸ’¡</span> Ù…Ø³Ø§Ø¹Ø¯Ø© (30 Ù†Ù‚Ø·Ø©)
        </button>

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨ -->
        <div class="board-wrapper" id="boardWrapper">
            <div class="board" id="board"></div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙÙˆØ² -->
        <div class="victory-screen" id="victoryScreen">
            <div class="victory-content">
                <h1>ğŸ‰ Ø§Ù†ØªØµØ±Øª! ğŸ‰</h1>
                <div style="font-size: 40px;" id="victoryStars">â˜…â˜…â˜…</div>
                <button onclick="goToNextLevel()">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â–¶</button>
            </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <div class="nav-buttons">
            <div class="nav-btn" onclick="prevLevel()" id="prevBtn">â—€ Ø±Ø¬ÙˆØ¹</div>
            <div class="nav-btn" onclick="resetLevel()">Ø¥Ø¹Ø§Ø¯Ø©</div>
            <div class="nav-btn" onclick="nextLevel()" id="nextBtn">ØªØ§Ù„ÙŠ â–¶</div>
        </div>
    </div>

    <div class="message-popup" id="messagePopup"></div>

    <script>
        // ------------------------------------------------------------
        //                     Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©
        // ------------------------------------------------------------

        // Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©
        let completedLevels = JSON.parse(localStorage.getItem('completedLevels')) || [];
        let gamePaused = false;
        let currentBoosterPieces = [];

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let currentLevel = 0;
        let board = [];
        let score = 0;
        let selectedRow = -1, selectedCol = -1;
        let boosters = { arrow: 0, bomb: 0 };
        let gameActive = true;
        let numbersPool = [];

        // ------------------------------------------------------------
        //                     ØªÙˆÙ„ÙŠØ¯ 20 Ù…Ø±Ø­Ù„Ø©
        // ------------------------------------------------------------
        function generateLevels() {
            let levels = [];
            for (let i = 1; i <= 20; i++) {
                let uniqueNumbers, obstacleCount, iceCount, target;
                
                if (i <= 3) {
                    uniqueNumbers = 3;
                    obstacleCount = 0;
                    iceCount = 0;
                    target = 200;
                } else if (i <= 5) {
                    uniqueNumbers = 4;
                    obstacleCount = 3;
                    iceCount = 1;
                    target = 350;
                } else if (i <= 10) {
                    uniqueNumbers = 5;
                    obstacleCount = 5;
                    iceCount = 2;
                    target = 500;
                } else {
                    uniqueNumbers = 6;
                    obstacleCount = 7;
                    iceCount = 3;
                    target = 700;
                }

                levels.push({
                    id: i,
                    rows: i > 15 ? 7 : 6,
                    cols: i > 15 ? 7 : 6,
                    target: target + i * 20,
                    uniqueNumbers: uniqueNumbers,
                    obstacles: generateObstacles(obstacleCount, i > 15 ? 7 : 6, i > 15 ? 7 : 6),
                    ice: generateIce(iceCount, i > 15 ? 7 : 6, i > 15 ? 7 : 6),
                    arrowRate: i <= 3 ? 1 : i <= 5 ? 0.7 : 0.4,
                    bombRate: i <= 3 ? 0.8 : i <= 5 ? 0.5 : 0.2
                });
            }
            return levels;
        }

        function generateObstacles(count, rows, cols) {
            let obs = [];
            for (let i = 0; i < count; i++) {
                obs.push({ row: Math.floor(Math.random() * rows), col: Math.floor(Math.random() * cols) });
            }
            return obs;
        }

        function generateIce(count, rows, cols) {
            let ice = [];
            for (let i = 0; i < count; i++) {
                ice.push({ row: Math.floor(Math.random() * rows), col: Math.floor(Math.random() * cols), layers: 2 });
            }
            return ice;
        }

        const levels = generateLevels();

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        function updateNumbersPool(level) {
            numbersPool = [];
            for (let i = 1; i <= level.uniqueNumbers; i++) numbersPool.push(i);
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø¨Ø¯ÙˆÙ† ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø£ÙˆÙ„ÙŠØ©
        function createRandomBoard(rows, cols) {
            let b = [];
            for (let r = 0; r < rows; r++) {
                let row = [];
                for (let c = 0; c < cols; c++) {
                    row.push(numbersPool[Math.floor(Math.random() * numbersPool.length)]);
                }
                b.push(row);
            }
            
            while (hasInitialMatches(b)) {
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        b[r][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                    }
                }
            }
            return b;
        }

        function hasInitialMatches(board) {
            let rows = board.length, cols = board[0].length;
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols - 2; c++) {
                    if (board[r][c] === board[r][c+1] && board[r][c] === board[r][c+2]) return true;
                }
            }
            for (let c = 0; c < cols; c++) {
                for (let r = 0; r < rows - 2; r++) {
                    if (board[r][c] === board[r+1][c] && board[r][c] === board[r+2][c]) return true;
                }
            }
            return false;
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª
        // ------------------------------------------------------------
        function checkMatches(board) {
            let matches = [];
            let matchDetails = [];
            let rows = board.length, cols = board[0].length;

            // Ø£ÙÙ‚ÙŠ
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols - 2; c++) {
                    if (board[r][c] && board[r][c+1] && board[r][c+2] && 
                        board[r][c] === board[r][c+1] && board[r][c] === board[r][c+2]) {
                        
                        let len = 3;
                        let val = board[r][c];
                        
                        if (c+3 < cols && board[r][c] === board[r][c+3]) {
                            len = 4;
                            if (c+4 < cols && board[r][c] === board[r][c+4]) len = 5;
                        }
                        
                        for (let i = 0; i < len; i++) {
                            matches.push([r, c+i]);
                            matchDetails.push({ row: r, col: c+i, value: val, length: len });
                        }
                    }
                }
            }

            // Ø¹Ù…ÙˆØ¯ÙŠ
            for (let c = 0; c < cols; c++) {
                for (let r = 0; r < rows - 2; r++) {
                    if (board[r][c] && board[r+1][c] && board[r+2][c] && 
                        board[r][c] === board[r+1][c] && board[r][c] === board[r+2][c]) {
                        
                        let len = 3;
                        let val = board[r][c];
                        
                        if (r+3 < rows && board[r][c] === board[r+3][c]) {
                            len = 4;
                            if (r+4 < rows && board[r][c] === board[r+4][c]) len = 5;
                        }
                        
                        for (let i = 0; i < len; i++) {
                            matches.push([r+i, c]);
                            matchDetails.push({ row: r+i, col: c, value: val, length: len });
                        }
                    }
                }
            }

            matches = [...new Set(matches.map(JSON.stringify))].map(JSON.parse);
            
            let uniqueDetails = [];
            let seen = new Set();
            matchDetails.forEach(d => {
                let key = `${d.row},${d.col}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueDetails.push(d);
                }
            });

            return { matches, matchDetails: uniqueDetails };
        }

        // ------------------------------------------------------------
        //                     Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª Ù…Ø¹ Ø³Ù‚ÙˆØ· Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        // ------------------------------------------------------------
        async function removeMatchesWithFall(board, matches, matchDetails) {
            if (gamePaused) return;
            
            let level = levels[currentLevel];
            let rows = board.length, cols = board[0].length;
            let totalPoints = 0;
            let boosterPositions = [];

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ¬Ù…Ø¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª
            matches.forEach(([r, c]) => {
                let detail = matchDetails.find(d => d.row === r && d.col === c);
                if (detail) {
                    let points = detail.value * detail.length;
                    totalPoints += points;
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ·Ø§Ø¨Ù‚ 4 Ø£Ùˆ 5ØŒ Ù†Ø¶ÙŠÙ Ù…Ø¹Ø²Ø² ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                    if (detail.length === 4 && Math.random() < level.arrowRate) {
                        boosterPositions.push({ row: r, col: c, type: 'arrow' });
                    } else if (detail.length === 5 && Math.random() < level.bombRate) {
                        boosterPositions.push({ row: r, col: c, type: 'bomb' });
                    }
                }
            });

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·
            score += totalPoints;
            showMessage(`+${totalPoints}`, 800);

            // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±
            let cells = document.querySelectorAll('.cell');
            matches.forEach(([r, c]) => {
                let index = r * cols + c;
                if (cells[index]) cells[index].classList.add('matching');
            });

            // Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø±
            await new Promise(resolve => setTimeout(resolve, 200));

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚Ø©
            for (let [r, c] of matches) {
                board[r][c] = null;
            }

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„ÙØ§Ø±ØºØ©
            for (let pos of boosterPositions) {
                if (!board[pos.row][pos.col]) {
                    currentBoosterPieces.push({
                        row: pos.row,
                        col: pos.col,
                        type: pos.type
                    });
                }
            }

            // Ø³Ù‚ÙˆØ· Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰
            for (let c = 0; c < cols; c++) {
                for (let r = rows - 1; r >= 0; r--) {
                    if (board[r][c] === null) {
                        for (let k = r - 1; k >= 0; k--) {
                            if (board[k][c] !== null) {
                                board[r][c] = board[k][c];
                                board[k][c] = null;
                                break;
                            }
                        }
                        if (board[r][c] === null) {
                            board[r][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                        }
                    }
                }
            }

            renderBoard();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
            await new Promise(resolve => setTimeout(resolve, 300));
            let { matches: newMatches, matchDetails: newDetails } = checkMatches(board);
            if (newMatches.length > 0) {
                await removeMatchesWithFall(board, newMatches, newDetails);
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ²
            if (score >= level.target && !completedLevels.includes(currentLevel)) {
                gamePaused = true;
                completedLevels.push(currentLevel);
                localStorage.setItem('completedLevels', JSON.stringify(completedLevels));
                
                let stars = calculateStars();
                document.getElementById('victoryStars').innerHTML = 'â˜…'.repeat(stars) + 'â˜†'.repeat(3-stars);
                document.getElementById('victoryScreen').style.display = 'flex';
            }
        }

        // ------------------------------------------------------------
        //                     Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø¬ÙˆÙ…
        // ------------------------------------------------------------
        function calculateStars() {
            let level = levels[currentLevel];
            let percent = score / level.target * 100;
            if (percent >= 200) return 3;
            if (percent >= 150) return 2;
            return 1;
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
        // ------------------------------------------------------------
        function handleBoosterClick(row, col, type) {
            if (gamePaused) return;
            
            let index = currentBoosterPieces.findIndex(b => b.row === row && b.col === col);
            if (index === -1) return;
            
            currentBoosterPieces.splice(index, 1);
            
            if (type === 'arrow') {
                useArrowInGame(row, col);
            } else if (type === 'bomb') {
                useBombInGame(row, col);
            }
        }

        function useArrowInGame(row, col) {
            let rows = board.length, cols = board[0].length;
            let points = 0;
            
            // Ø§Ù„Ø³Ù‡Ù… ÙŠÙ†Ø²Ù„ Ù„Ù„ØµÙ Ø§Ù„Ù„ÙŠ ØªØ­Øª
            let targetRow = Math.min(row + 1, rows - 1);
            
            for (let c = 0; c < cols; c++) {
                if (board[targetRow][c] !== null) {
                    points += board[targetRow][c];
                    board[targetRow][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                }
            }
            
            score += points;
            showMessage(`â¬‡ï¸ Ø§Ù„Ø³Ù‡Ù…: +${points}`, 1000);
            renderBoard();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
            setTimeout(() => {
                let { matches, matchDetails } = checkMatches(board);
                if (matches.length > 0) {
                    removeMatchesWithFall(board, matches, matchDetails);
                }
            }, 300);
        }

        function useBombInGame(row, col) {
            let rows = board.length, cols = board[0].length;
            let points = 0;
            
            for (let r = Math.max(0, row-1); r <= Math.min(rows-1, row+1); r++) {
                for (let c = Math.max(0, col-1); c <= Math.min(cols-1, col+1); c++) {
                    if (board[r][c] !== null) {
                        points += board[r][c];
                        board[r][c] = numbersPool[Math.floor(Math.random() * numbersPool.length)];
                    }
                }
            }
            
            score += points;
            showMessage(`ğŸ’£ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©: +${points}`, 1000);
            renderBoard();
            
            setTimeout(() => {
                let { matches, matchDetails } = checkMatches(board);
                if (matches.length > 0) {
                    removeMatchesWithFall(board, matches, matchDetails);
                }
            }, 300);
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªØ­Ø±ÙŠÙƒ
        // ------------------------------------------------------------
        async function handleCellClick(r, c) {
            if (gamePaused) return;
            
            let level = levels[currentLevel];
            if (level.obstacles.some(o => o.row === r && o.col === c)) return;

            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ù„ÙŠØ© ÙÙŠÙ‡Ø§ Ù…Ø¹Ø²Ø²
            let booster = currentBoosterPieces.find(b => b.row === r && b.col === c);
            if (booster) {
                handleBoosterClick(r, c, booster.type);
                return;
            }

            if (selectedRow === -1) {
                selectedRow = r;
                selectedCol = c;
                renderBoard();
                return;
            }

            let rowDiff = Math.abs(r - selectedRow);
            let colDiff = Math.abs(c - selectedCol);
            let isAdjacent = (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);

            if (isAdjacent) {
                let temp = board[r][c];
                board[r][c] = board[selectedRow][selectedCol];
                board[selectedRow][selectedCol] = temp;

                let { matches, matchDetails } = checkMatches(board);
                
                if (matches.length > 0) {
                    await removeMatchesWithFall(board, matches, matchDetails);
                } else {
                    temp = board[r][c];
                    board[r][c] = board[selectedRow][selectedCol];
                    board[selectedRow][selectedCol] = temp;
                    
                    document.querySelectorAll('.cell').forEach(c => c.classList.add('error'));
                    setTimeout(() => document.querySelectorAll('.cell').forEach(c => c.classList.remove('error')), 200);
                }
            }

            selectedRow = -1;
            selectedCol = -1;
            renderBoard();
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„Ù…Ø¹Ø²Ø²Ø§Øª Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ·
        // ------------------------------------------------------------
        let selectedBooster = null;

        function useBooster(type) {
            if (boosters[type] <= 0 || gamePaused) return;
            selectedBooster = type;
            showMessage(`Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† ${type === 'arrow' ? 'Ø§Ù„Ø³Ù‡Ù…' : 'Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©'}`, 1500);
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        // ------------------------------------------------------------
        function useHint() {
            if (score < 30 || gamePaused) {
                showMessage('âŒ Ø§Ù„Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ©', 1500);
                return;
            }

            for (let r = 0; r < board.length; r++) {
                for (let c = 0; c < board[0].length; c++) {
                    if (c + 1 < board[0].length) {
                        [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                        if (checkMatches(board).matches.length > 0) {
                            [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                            highlightCell(r, c);
                            score -= 30;
                            renderBoard();
                            return;
                        }
                        [board[r][c], board[r][c+1]] = [board[r][c+1], board[r][c]];
                    }
                    
                    if (r + 1 < board.length) {
                        [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                        if (checkMatches(board).matches.length > 0) {
                            [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                            highlightCell(r, c);
                            score -= 30;
                            renderBoard();
                            return;
                        }
                        [board[r][c], board[r+1][c]] = [board[r+1][c], board[r][c]];
                    }
                }
            }
            
            showMessage('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ© Ù…ØªØ§Ø­Ø©', 1500);
        }

        function highlightCell(r, c) {
            let index = r * board[0].length + c;
            document.querySelectorAll('.cell')[index]?.classList.add('hint');
            setTimeout(() => {
                document.querySelectorAll('.cell').forEach(el => el.classList.remove('hint'));
            }, 2000);
        }

        // ------------------------------------------------------------
        //                     Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        // ------------------------------------------------------------
        function showMessage(text, duration = 2000) {
            let msg = document.getElementById('messagePopup');
            msg.style.display = 'block';
            msg.textContent = text;
            setTimeout(() => msg.style.display = 'none', duration);
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        // ------------------------------------------------------------
        function goToNextLevel() {
            document.getElementById('victoryScreen').style.display = 'none';
            if (currentLevel < levels.length - 1) {
                currentLevel++;
                resetLevel();
            }
        }

        // ------------------------------------------------------------
        //                     ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        // ------------------------------------------------------------
        function renderBoard() {
            let level = levels[currentLevel];
            let boardDiv = document.getElementById('board');

            document.getElementById('levelDisplay').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${level.id}`;
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('arrowCount').textContent = boosters.arrow;
            document.getElementById('bombCount').textContent = boosters.bomb;

            document.getElementById('prevBtn').classList.toggle('disabled', currentLevel === 0);
            document.getElementById('nextBtn').classList.toggle('disabled', 
                currentLevel === levels.length-1 || !completedLevels.includes(currentLevel));

            boardDiv.style.gridTemplateColumns = `repeat(${level.cols}, 70px)`;
            boardDiv.innerHTML = '';

            for (let r = 0; r < level.rows; r++) {
                for (let c = 0; c < level.cols; c++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø²Ø² ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ù„ÙŠØ©
                    let booster = currentBoosterPieces.find(b => b.row === r && b.col === c);
                    
                    if (booster) {
                        cell.classList.add('booster-piece', booster.type);
                        cell.textContent = booster.type === 'arrow' ? 'â¬…ï¸â¡ï¸' : 'ğŸ’£';
                    } else if (level.obstacles.some(o => o.row === r && o.col === c)) {
                        cell.classList.add('obstacle');
                    } else {
                        let num = board[r][c];
                        cell.textContent = num;
                        cell.classList.add(`num-${num}`);
                        
                        if (level.ice.some(i => i.row === r && i.col === c)) {
                            cell.classList.add('ice');
                        }
                    }

                    if (selectedRow === r && selectedCol === c && !booster) {
                        cell.classList.add('selected');
                    }

                    cell.onclick = () => handleCellClick(r, c);
                    boardDiv.appendChild(cell);
                }
            }
        }

        // ------------------------------------------------------------
        //                     Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        // ------------------------------------------------------------
        function nextLevel() {
            if (currentLevel < levels.length - 1 && completedLevels.includes(currentLevel)) {
                currentLevel++;
                resetLevel();
            }
        }

        function prevLevel() {
            if (currentLevel > 0) {
                currentLevel--;
                resetLevel();
            }
        }

        function resetLevel() {
            let level = levels[currentLevel];
            updateNumbersPool(level);
            board = createRandomBoard(level.rows, level.cols);
            score = 0;
            selectedRow = -1;
            selectedBooster = null;
            currentBoosterPieces = [];
            gamePaused = false;
            boosters = { 
                arrow: level.id <= 3 ? 3 : level.id <= 5 ? 2 : 1,
                bomb: level.id <= 3 ? 2 : level.id <= 5 ? 1 : 0
            };
            document.getElementById('victoryScreen').style.display = 'none';
            renderBoard();
        }

        // ------------------------------------------------------------
        //                     Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        // ------------------------------------------------------------
        resetLevel();
    </script>
</body>
</html>
